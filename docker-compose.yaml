services:
  cdk:
    build: ./docker/cdk
    env_file:
      - .env.localstack
    environment:
      AWS_ENDPOINT_URL: http://${DOCKER_LOCALSTACK_IP:-10.5.0.5}:4566
      AWS_ENDPOINT_URL_S3: http://${DOCKER_LOCALSTACK_IP:-10.5.0.5}:4566
      AES_KEY: ${AES_KEY:-12345678901234567890123456789012}
      BITBUCKET_CLIENT_ID: ${BITBUCKET_CLIENT_ID:-key_bitbucket}
      BITBUCKET_CLIENT_SECRET: ${BITBUCKET_CLIENT_SECRET:-secret_bitbucket}
      GITHUB_ACCESS_TOKEN: ${GITHUB_ACCESS_TOKEN:-token_github}
    volumes:
      - ./localstack/app:/app
    depends_on:
      - localstack
    networks:
      - localstack
  mcp-gateway:
    image: node:22.20-bookworm
    env_file:
      - .env.localstack
    working_dir: /app
    user: 1000:1000
    command: yarn start:dev-install
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: development
      CLOUD_PROVIDER: aws
      AWS_ENDPOINT_URL: http://${DOCKER_LOCALSTACK_IP:-10.5.0.5}:4566
      AWS_ENDPOINT_URL_S3: http://${DOCKER_LOCALSTACK_IP:-10.5.0.5}:4566
      AWS_REGION: us-east-1
      AWS_EVENTBUS_NAME: tvo-event-bus-local
      AWS_QUEUE_URL: http://10.5.0.5:4566/000000000000/tvo-mcp-gateway-output-local
      AWS_DYNAMODB_TABLE_NAME: tvo-mcp-jobs-local
    volumes:
      - ./src/mcp/gateway:/app
    depends_on:
      - localstack
    networks:
      - localstack
  git-commit-files:
    build: ./docker/lambda/node
    env_file:
      - .env.localstack
    environment:
      AWS_ENDPOINT_URL: http://${DOCKER_LOCALSTACK_IP:-10.5.0.5}:4566
      AWS_ENDPOINT_URL_S3: http://${DOCKER_LOCALSTACK_IP:-10.5.0.5}:4566
      CDK_STACK_NAME: McpGitCommitFilesStack
    volumes:
      - ./src/mcp/git-commit-files:/home/node/app
    depends_on:
      - localstack
    networks:
      - localstack
  bitbucket-code-insights:
    build: ./docker/lambda/node
    env_file:
      - .env.localstack
    environment:
      AWS_ENDPOINT_URL: http://${DOCKER_LOCALSTACK_IP:-10.5.0.5}:4566
      AWS_ENDPOINT_URL_S3: http://${DOCKER_LOCALSTACK_IP:-10.5.0.5}:4566
      CDK_STACK_NAME: McpBitbucketCodeInsightsStack
    volumes:
      - ./src/mcp/bitbucket-code-insights:/home/node/app
    depends_on:
      - localstack
    networks:
      - localstack
  github-issue:
    build: ./docker/lambda/node
    env_file:
      - .env.localstack
    environment:
      AWS_ENDPOINT_URL: http://${DOCKER_LOCALSTACK_IP:-10.5.0.5}:4566
      AWS_ENDPOINT_URL_S3: http://${DOCKER_LOCALSTACK_IP:-10.5.0.5}:4566
      CDK_STACK_NAME: McpGithubIssueStack
    volumes:
      - ./src/mcp/github-issue:/home/node/app
    depends_on:
      - localstack
    networks:
      - localstack
  issue-report:
    build: ./docker/lambda/node
    env_file:
      - .env.localstack
    environment:
      AWS_ENDPOINT_URL: http://${DOCKER_LOCALSTACK_IP:-10.5.0.5}:4566
      AWS_ENDPOINT_URL_S3: http://${DOCKER_LOCALSTACK_IP:-10.5.0.5}:4566
      CDK_STACK_NAME: McpIssueReportStack
    volumes:
      - ./src/mcp/issue-report:/home/node/app
    depends_on:
      - localstack
    networks:
      - localstack
  agent:
    build: ./docker/batch
    volumes:
      - ./src/agent:/app
      - /var/run/docker.sock:/var/run/docker.sock
  trigger:
    build: ./docker/lambda/node
    env_file:
      - .env.localstack
    environment:
      AWS_ENDPOINT_URL: http://${DOCKER_LOCALSTACK_IP:-10.5.0.5}:4566
      AWS_ENDPOINT_URL_S3: http://${DOCKER_LOCALSTACK_IP:-10.5.0.5}:4566
      CDK_STACK_NAME: ApiTaskTriggerStack
    volumes:
      - ./src/api/task/trigger:/home/node/app
    depends_on:
      - localstack
    networks:
      - localstack
  localstack:
    image: localstack/localstack:4.8.1
    ports:
      - 4566:4566
      - 4510-4559:4510-4559
    volumes:
      - localstack:/var/lib/localstack
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      localstack:
        ipv4_address: ${DOCKER_LOCALSTACK_IP:-10.5.0.5}
volumes:
  localstack:

networks:
  localstack:
    driver: bridge
    ipam:
      config:
        - subnet: ${DOCKER_NETWORK_SUBNET:-10.5.0.0/16}
          gateway: ${DOCKER_NETWORK_GATEWAY:-10.5.0.1}