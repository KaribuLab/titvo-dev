services:
  cdk:
    build: ./docker/cdk
    env_file:
      - .env.localstack
    environment:
      AWS_ENDPOINT_URL: http://${DOCKER_LOCALSTACK_IP:-10.5.0.5}:4566
      AWS_ENDPOINT_URL_S3: http://${DOCKER_LOCALSTACK_IP:-10.5.0.5}:4566
      AES_KEY: ${AES_KEY:-12345678901234567890123456789012}
      BITBUCKET_CLIENT_ID: ${BITBUCKET_CLIENT_ID:-key_bitbucket}
      BITBUCKET_CLIENT_SECRET: ${BITBUCKET_CLIENT_SECRET:-secret_bitbucket}
    volumes:
      - ./localstack/app:/app
    depends_on:
      - localstack
    networks:
      - localstack
  git-commit-files:
    build: ./docker/lambda/node
    env_file:
      - .env.localstack
    environment:
      AWS_ENDPOINT_URL: http://${DOCKER_LOCALSTACK_IP:-10.5.0.5}:4566
      AWS_ENDPOINT_URL_S3: http://${DOCKER_LOCALSTACK_IP:-10.5.0.5}:4566
      CDK_STACK_NAME: McpGitCommitFilesStack
    volumes:
      - ./src/mcp/git-commit-files:/home/node/app
    depends_on:
      - localstack
    networks:
      - localstack
  bitbucket-code-insights:
    build: ./docker/lambda/node
    env_file:
      - .env.localstack
    environment:
      AWS_ENDPOINT_URL: http://${DOCKER_LOCALSTACK_IP:-10.5.0.5}:4566
      AWS_ENDPOINT_URL_S3: http://${DOCKER_LOCALSTACK_IP:-10.5.0.5}:4566
      CDK_STACK_NAME: McpBitbucketCodeInsightsStack
    volumes:
      - ./src/mcp/bitbucket-code-insights:/home/node/app
    depends_on:
      - localstack
    networks:
      - localstack
  issue-report:
    build: ./docker/lambda/node
    env_file:
      - .env.localstack
    environment:
      AWS_ENDPOINT_URL: http://${DOCKER_LOCALSTACK_IP:-10.5.0.5}:4566
      AWS_ENDPOINT_URL_S3: http://${DOCKER_LOCALSTACK_IP:-10.5.0.5}:4566
      CDK_STACK_NAME: McpIssueReportStack
    volumes:
      - ./src/mcp/issue-report:/home/node/app
    depends_on:
      - localstack
    networks:
      - localstack
  localstack:
    image: localstack/localstack:4.8.1
    ports:
      - 4566:4566
      - 4510-4559:4510-4559
    volumes:
      - localstack:/var/lib/localstack
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      localstack:
        ipv4_address: ${DOCKER_LOCALSTACK_IP:-10.5.0.5}
volumes:
  localstack:

networks:
  localstack:
    driver: bridge
    ipam:
      config:
        - subnet: ${DOCKER_NETWORK_SUBNET:-10.5.0.0/16}
          gateway: ${DOCKER_NETWORK_GATEWAY:-10.5.0.1}